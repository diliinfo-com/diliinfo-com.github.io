# ç”¨æˆ·æ³¨å†Œç”³è¯·é›†æˆä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·æ³¨å†Œå¹¶ç”³è¯·è´·æ¬¾æ—¶ï¼Œåªæœ‰ç¬¬1æ­¥çš„è®°å½•èƒ½å¤Ÿåœ¨ç®¡ç†åå°çœ‹åˆ°ï¼Œç¬¬2æ­¥åŠä»¥åæ­¥éª¤çš„è®°å½•åœ¨åå°ç®¡ç†ç•Œé¢éƒ½çœ‹ä¸åˆ°ã€‚

## æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡æ·±å…¥è°ƒè¯•å‘ç°ï¼Œé—®é¢˜ä¸åœ¨åç«¯APIï¼ˆåç«¯å·¥ä½œå®Œå…¨æ­£å¸¸ï¼‰ï¼Œè€Œåœ¨å‰ç«¯çš„ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼š

### ğŸ” é—®é¢˜æ ¹æº
**ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œå‰ç«¯æ²¡æœ‰æ­£ç¡®æ›´æ–° `applicationData.id`ï¼Œå¯¼è‡´åç»­æ­¥éª¤è°ƒç”¨æ—¶ä½¿ç”¨äº†é”™è¯¯çš„ç”³è¯·IDã€‚**

### ğŸ“Š æµ‹è¯•éªŒè¯
é€šè¿‡APIæµ‹è¯•è„šæœ¬éªŒè¯ï¼š
- âœ… åç«¯APIå®Œå…¨æ­£å¸¸å·¥ä½œ
- âœ… æ­¥éª¤æ•°æ®æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
- âœ… ç®¡ç†åå°APIè¿”å›æ­£ç¡®æ•°æ®
- âŒ å‰ç«¯ç”¨æˆ·æ³¨å†Œæµç¨‹æœ‰é—®é¢˜

### ğŸ”„ æ•°æ®æµé—®é¢˜
1. **è®¿å®¢ç”³è¯·åˆ›å»º** - åˆ›å»ºè®¿å®¢ç”³è¯·è®°å½•ï¼Œè·å¾— `applicationId`
2. **ç”¨æˆ·æ³¨å†Œ** - ç”¨æˆ·å¡«å†™æ‰‹æœºå·å’Œå¯†ç æ³¨å†Œ
3. **âŒ å…³é”®é—®é¢˜** - æ³¨å†ŒæˆåŠŸåï¼Œå‰ç«¯æ²¡æœ‰æ›´æ–° `applicationData.id`
4. **åç»­æ­¥éª¤å¤±è´¥** - ä½¿ç”¨é”™è¯¯çš„ç”³è¯·IDè°ƒç”¨APIï¼Œå¯¼è‡´æ•°æ®ä¿å­˜å¤±è´¥

## ä¿®å¤æ–¹æ¡ˆ

### å‰ç«¯ä¿®å¤ (apps/web/src/components/LoanWizard.tsx)

**ä¿®å¤å‰**:
```typescript
.then(result => {
  if (result.success) {
    if (updateApplicationStep) {
      updateApplicationStep(1, { phone: fullPhone, registered: true });
    }
    onUpdate({ phone: fullPhone, isGuest: false });
    onNext();
  }
})
```

**ä¿®å¤å**:
```typescript
.then(result => {
  if (result.success) {
    // æ›´æ–°ç”³è¯·æ•°æ®ï¼ŒåŒ…æ‹¬ç”³è¯·ID
    const updatedData = { 
      phone: fullPhone, 
      isGuest: false,
      id: result.applicationId || data.id // ä½¿ç”¨è¿”å›çš„ç”³è¯·ID
    };
    onUpdate(updatedData);
    
    if (updateApplicationStep) {
      updateApplicationStep(1, { phone: fullPhone, registered: true });
    }
    onNext();
  }
})
```

### åç«¯éªŒè¯ (workers-backend/index.ts)

åç«¯ç”¨æˆ·æ³¨å†ŒAPIå·²ç»æ­£ç¡®è¿”å› `applicationId`ï¼š
```typescript
return c.json({ 
  success: true, 
  token,
  user: { id: userId, phone, phone_verified: true },
  applicationId: applicationId || null // âœ… æ­£ç¡®è¿”å›ç”³è¯·ID
});
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- ç”¨æˆ·æ³¨å†Œåï¼Œ`applicationData.id` ä¿æŒä¸ºè®¿å®¢ç”³è¯·ID
- åç»­æ­¥éª¤è°ƒç”¨ä½¿ç”¨é”™è¯¯çš„ID
- æ•°æ®ä¿å­˜å¤±è´¥ï¼Œç®¡ç†åå°åªæ˜¾ç¤ºç¬¬1æ­¥

### ä¿®å¤å
- ç”¨æˆ·æ³¨å†Œåï¼Œ`applicationData.id` æ›´æ–°ä¸ºæ­£ç¡®çš„ç”³è¯·ID
- åç»­æ­¥éª¤è°ƒç”¨ä½¿ç”¨æ­£ç¡®çš„ID
- æ•°æ®æ­£ç¡®ä¿å­˜ï¼Œç®¡ç†åå°æ˜¾ç¤ºå®Œæ•´è¿›åº¦

## æµ‹è¯•éªŒè¯

### APIæµ‹è¯•ç»“æœ
```json
{
  "application": {
    "completed_steps": 7,
    "id_number": "123456789012345678",
    "real_name": "æµ‹è¯•ç”¨æˆ·",
    "contact1_name": "è”ç³»äºº1",
    "bank_card_number": "1234567890123456"
  },
  "steps": [
    {"step_number": 1, "step_name": "application_started"},
    {"step_number": 2, "step_name": "identity_info"},
    {"step_number": 4, "step_name": "contacts_info"},
    {"step_number": 7, "step_name": "bank_card"}
  ]
}
```

### é¢„æœŸç”¨æˆ·ä½“éªŒ
1. **ç”¨æˆ·æ³¨å†Œ** - å¡«å†™æ‰‹æœºå·å’Œå¯†ç 
2. **èº«ä»½ä¿¡æ¯** - å¡«å†™çœŸå®å§“åå’Œèº«ä»½è¯å·
3. **è”ç³»äººä¿¡æ¯** - å¡«å†™è”ç³»äººä¿¡æ¯
4. **é“¶è¡Œå¡ä¿¡æ¯** - å¡«å†™é“¶è¡Œå¡å·
5. **ç®¡ç†åå°** - æ˜¾ç¤ºæ­£ç¡®çš„è¿›åº¦ï¼ˆå¦‚ 4/12ï¼‰å’Œå®Œæ•´ä¿¡æ¯

## éƒ¨ç½²çŠ¶æ€

- âœ… å‰ç«¯ä¿®å¤å·²å®Œæˆ
- âœ… ä»£ç å·²é‡æ–°æ„å»º
- âœ… ä¿®å¤å·²éƒ¨ç½²

## æµ‹è¯•å»ºè®®

1. **å®Œæ•´æ³¨å†Œæµç¨‹æµ‹è¯•**:
   - è®¿é—®è´·æ¬¾ç”³è¯·é¡µé¢
   - å®Œæˆç”¨æˆ·æ³¨å†Œï¼ˆç¬¬1æ­¥ï¼‰
   - ç»§ç»­å¡«å†™èº«ä»½ä¿¡æ¯ï¼ˆç¬¬2æ­¥ï¼‰
   - å¡«å†™è”ç³»äººä¿¡æ¯ï¼ˆç¬¬4æ­¥ï¼‰
   - å¡«å†™é“¶è¡Œå¡ä¿¡æ¯ï¼ˆç¬¬7æ­¥ï¼‰

2. **ç®¡ç†åå°éªŒè¯**:
   - æŸ¥çœ‹ç”³è¯·åˆ—è¡¨ï¼Œç¡®è®¤è¿›åº¦æ˜¾ç¤ºæ­£ç¡®ï¼ˆå¦‚ 4/12ï¼‰
   - ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"ï¼Œç¡®è®¤æ‰€æœ‰å¡«å†™çš„ä¿¡æ¯éƒ½æ˜¾ç¤º

3. **æ•°æ®åº“éªŒè¯**:
   - æ£€æŸ¥ `loan_applications` è¡¨ä¸­çš„ç”³è¯·è®°å½•
   - æ£€æŸ¥ `application_steps` è¡¨ä¸­çš„æ­¥éª¤è®°å½•

## å…³é”®å­¦ä¹ ç‚¹

1. **å‰åç«¯æ•°æ®æµ** - ç¡®ä¿å‰ç«¯æ­£ç¡®å¤„ç†åç«¯è¿”å›çš„å…³é”®æ•°æ®
2. **ç”³è¯·IDç®¡ç†** - ç”¨æˆ·æ³¨å†Œåå¿…é¡»æ›´æ–°ç”³è¯·ID
3. **çŠ¶æ€åŒæ­¥** - å‰ç«¯çŠ¶æ€å¿…é¡»ä¸åç«¯æ•°æ®ä¿æŒä¸€è‡´
4. **è°ƒè¯•æ–¹æ³•** - é€šè¿‡APIæµ‹è¯•å¯ä»¥å¿«é€Ÿå®šä½å‰åç«¯é—®é¢˜

è¿™ä¸ªä¿®å¤è§£å†³äº†ç”¨æˆ·æ³¨å†Œç”³è¯·æµç¨‹ä¸­çš„å…³é”®é—®é¢˜ï¼Œç¡®ä¿äº†æ•°æ®çš„å®Œæ•´æ€§å’Œç”¨æˆ·ä½“éªŒçš„è¿ç»­æ€§ã€‚